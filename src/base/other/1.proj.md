---
lang: zh-CN
sidebarDepth: 2
meta:
  - name: description
    content: 个人总结的openlayers学习技术文档-主题
  - name: keywords
    content: vuepress,最新技术文档,vuepress主题
---

# 一.proj

## 4.渲染 16 位 NumpyTiles

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
  <div>
    <h5>Contrast stretch</h5>
    <ul>
      <li>
        Min <input type="range" min="1000" max="10000" id="input-min" />
        <span id="output-min"></span>
      </li>
      <li>
        Max <input type="range" min="10000" max="50000" id="input-max" />
        <span id="output-max"></span>
      </li>
    </ul>
  </div>
</template>

<script>
export default {
  mounted() {
    let {
      Map,
      View,
      layer: { WebGLTile: TileLayer },
      source: { DataTile: DataTileSource },
      proj: { fromLonLat },
    } = ol
    const COG =
      "https://storage.googleapis.com/open-cogs/stac-examples/20201211_223832_CS2_analytic.tif"

    function numpyTileLoader(z, x, y) {
      const url = `https://api.cogeo.xyz/cog/tiles/WebMercatorQuad/${z}/${x}/${y}@1x?format=npy&url=${encodeURIComponent(
        COG
      )}`
      return fetch(url)
        .then((r) => r.arrayBuffer())
        .then((buffer) => NumpyLoader.fromArrayBuffer(buffer))
        .then((numpyData) => {
          const dataTile = new Float32Array(256 * 256 * 5)
          const bandSize = 256 * 256
          for (let x = 0; x < 256; x++) {
            for (let y = 0; y < 256; y++) {
              const px = x + y * 256
              dataTile[px * 5 + 0] = numpyData.data[y * 256 + x]
              dataTile[px * 5 + 1] = numpyData.data[bandSize + y * 256 + x]
              dataTile[px * 5 + 2] = numpyData.data[bandSize * 2 + y * 256 + x]
              dataTile[px * 5 + 3] = numpyData.data[bandSize * 3 + y * 256 + x]
              dataTile[px * 5 + 4] =
                numpyData.data[bandSize * 4 + y * 256 + x] > 0 ? 1.0 : 0
            }
          }
          return dataTile
        })
    }

    const interpolateBand = (bandIdx) => [
      "interpolate",
      ["linear"],
      ["band", bandIdx],
      ["var", "bMin"],
      0,
      ["var", "bMax"],
      1,
    ]
    const initialMin = 3000
    const initialMax = 18000
    const numpyLayer = new TileLayer({
      style: {
        color: [
          "array",
          interpolateBand(3),
          interpolateBand(2),
          interpolateBand(1),
          ["band", 5],
        ],
        variables: {
          bMin: initialMin,
          bMax: initialMax,
        },
      },
      source: new DataTileSource({
        loader: numpyTileLoader,
        bandCount: 5,
      }),
    })
    const map = new Map({
      target: this.$refs.map,
      layers: [numpyLayer],
      view: new View({
        center: fromLonLat([172.933, 1.3567]),
        zoom: 15,
      }),
    })
    const inputMin = document.getElementById("input-min")
    const inputMax = document.getElementById("input-max")
    const outputMin = document.getElementById("output-min")
    const outputMax = document.getElementById("output-max")
    const handleMin = (evt) => {
      numpyLayer.updateStyleVariables({
        bMin: parseFloat(evt.target.value),
        bMax: parseFloat(inputMax.value),
      })
      outputMin.innerText = evt.target.value
    }
    inputMin.addEventListener("input", handleMin)
    inputMin.addEventListener("change", handleMin)
    const handleMax = (evt) => {
      numpyLayer.updateStyleVariables({
        bMin: parseFloat(inputMin.value),
        bMax: parseFloat(evt.target.value),
      })
      outputMax.innerText = evt.target.value
    }
    inputMax.addEventListener("input", handleMax)
    inputMax.addEventListener("change", handleMax)
    inputMin.value = initialMin
    inputMax.value = initialMax
    outputMin.innerText = initialMin
    outputMax.innerText = initialMax
  },
}
</script>
```

:::

## 5.使用 EPSG.io 搜索重新投影

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
  <form class="form-inline">
    <label for="epsg-query">Search projection:&nbsp</label>
    <input
      type="text"
      id="epsg-query"
      placeholder="4326, 27700, 3031, US National Atlas, Swiss, France, ..."
      class="form-control"
      size="50"
    />
    <button id="epsg-search" class="btn">Search</button>
    <span id="epsg-result"></span>
  </form>
  <form class="form-inline">
    <label for="render-edges">
      Render reprojection edges:&nbsp;
      <input type="checkbox" id="render-edges" />
    </label>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <label for="show-tiles">
      Show tile coordinates:&nbsp;
      <input type="checkbox" id="show-tiles" />
    </label>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <label for="show-graticule">
      Show graticule:&nbsp;
      <input type="checkbox" id="show-graticule" />
    </label>
  </form>
</template>

<script>
export default {
  mounted() {
    // import proj4 from 'proj4';
    let {
      extent: { applyTransform },
      Map,
      View,
      layer: { Tile: TileLayer, Graticule },
      source: { OSM, Vector: VectorSource, TileDebug },
      style: { Stroke },
      proj: {
        get: getProjection,
        getTransform,
        proj4: { register },
      },
    } = ol

    const osmSource = new OSM()

    const debugLayer = new TileLayer({
      source: new TileDebug({
        tileGrid: osmSource.getTileGrid(),
        projection: osmSource.getProjection(),
      }),
      visible: false,
    })

    const graticule = new Graticule({
      strokeStyle: new Stroke({
        color: "rgba(255,120,0,0.9)",
        width: 2,
        lineDash: [0.5, 4],
      }),
      showLabels: true,
      visible: false,
      wrapX: false,
    })

    const map = new Map({
      layers: [
        new TileLayer({
          source: osmSource,
        }),
        debugLayer,
        graticule,
      ],
      target: this.$refs.map,
      view: new View({
        projection: "EPSG:3857",
        center: [12579156, 3274244],
        zoom: 1,
      }),
    })

    const queryInput = document.getElementById("epsg-query")
    const searchButton = document.getElementById("epsg-search")
    const resultSpan = document.getElementById("epsg-result")
    const renderEdgesCheckbox = document.getElementById("render-edges")
    const showTilesCheckbox = document.getElementById("show-tiles")
    const showGraticuleCheckbox = document.getElementById("show-graticule")

    function setProjection(code, name, proj4def, bbox) {
      if (
        code === null ||
        name === null ||
        proj4def === null ||
        bbox === null
      ) {
        resultSpan.innerHTML = "Nothing usable found, using EPSG:3857..."
        map.setView(
          new View({
            projection: "EPSG:3857",
            center: [12579156, 3274244],
            zoom: 1,
          })
        )
        return
      }

      resultSpan.innerHTML = "(" + code + ") " + name

      const newProjCode = "EPSG:" + code
      proj4.defs(newProjCode, proj4def)
      register(proj4)
      const newProj = getProjection(newProjCode)
      const fromLonLat = getTransform("EPSG:4326", newProj)

      let worldExtent = [bbox[1], bbox[2], bbox[3], bbox[0]]
      newProj.setWorldExtent(worldExtent)

      // approximate calculation of projection extent,
      // checking if the world extent crosses the dateline
      if (bbox[1] > bbox[3]) {
        worldExtent = [bbox[1], bbox[2], bbox[3] + 360, bbox[0]]
      }
      const extent = applyTransform(worldExtent, fromLonLat, undefined, 8)
      newProj.setExtent(extent)
      const newView = new View({
        projection: newProj,
      })
      map.setView(newView)
      newView.fit(extent)
    }

    function search(query) {
      resultSpan.innerHTML = "Searching ..."
      fetch("https://epsg.io/?format=json&q=" + query)
        .then(function (response) {
          return response.json()
        })
        .then(function (json) {
          const results = json["results"]
          if (results && results.length > 0) {
            for (let i = 0, ii = results.length; i < ii; i++) {
              const result = results[i]
              if (result) {
                const code = result["code"]
                const name = result["name"]
                const proj4def = result["proj4"]
                const bbox = result["bbox"]
                if (
                  code &&
                  code.length > 0 &&
                  proj4def &&
                  proj4def.length > 0 &&
                  bbox &&
                  bbox.length == 4
                ) {
                  setProjection(code, name, proj4def, bbox)
                  return
                }
              }
            }
          }
          setProjection(null, null, null, null)
        })
    }

    /**
     * Handle click event.
     * @param {Event} event The event.
     */
    searchButton.onclick = function (event) {
      search(queryInput.value)
      event.preventDefault()
    }

    /**
     * Handle checkbox change events.
     */
    renderEdgesCheckbox.onchange = function () {
      osmSource.setRenderReprojectionEdges(renderEdgesCheckbox.checked)
    }
    showTilesCheckbox.onchange = function () {
      debugLayer.setVisible(showTilesCheckbox.checked)
    }
    showGraticuleCheckbox.onchange = function () {
      graticule.setVisible(showGraticuleCheckbox.checked)
    }
  },
}
</script>
```

:::

## 5.Image 重新投影

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
  <div>
    <input type="checkbox" id="interpolate" checked />
    <label for="interpolate">Interpolate</label>
  </div>
</template>

<script>
export default {
  mounted() {
    let {
      Map,
      View,
      layer: { Tile: TileLayer, Image: ImageLayer },
      source: { OSM, ImageStatic: Static },
      style: Style,
      proj: {
        transform,
        proj4: { register },
      },
      extent: { getCenter },
      // import proj4 from 'proj4';
    } = ol

    proj4.defs(
      "EPSG:27700",
      "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 " +
        "+x_0=400000 +y_0=-100000 +ellps=airy " +
        "+towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 " +
        "+units=m +no_defs"
    )
    register(proj4)

    const imageExtent = [0, 0, 700000, 1300000]
    const imageLayer = new ImageLayer()

    const map = new Map({
      layers: [
        new TileLayer({
          source: new OSM(),
        }),
        imageLayer,
      ],
      target: this.$refs.map,
      view: new View({
        center: transform(getCenter(imageExtent), "EPSG:27700", "EPSG:3857"),
        zoom: 4,
      }),
    })

    const interpolate = document.getElementById("interpolate")

    function setSource() {
      const source = new Static({
        url:
          "https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/" +
          "British_National_Grid.svg/2000px-British_National_Grid.svg.png",
        crossOrigin: "",
        projection: "EPSG:27700",
        imageExtent: imageExtent,
        interpolate: interpolate.checked,
      })
      imageLayer.setSource(source)
    }
    setSource()

    interpolate.addEventListener("change", setSource)
  },
}
</script>
```

:::
