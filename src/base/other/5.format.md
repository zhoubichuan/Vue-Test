---
lang: zh-CN
sidebarDepth: 2
meta:
  - name: description
    content: 个人总结的openlayers学习技术文档-主题
  - name: keywords
    content: vuepress,最新技术文档,vuepress主题
---

# 五.format

## 1.WMTSCapabilities

WMTS 源有一个 tilePixelRatio 选项。支持 HiDPI 的 WMTS 可以提供具有 512x512 像素图块的图块，但在 256x256 像素图块网格中使用它们。在这种情况下 tilePixelRatio 需要设置为 2
:::demo

```vue
<template>
  <div ref="map" class="map"></div>
</template>

<script>
export default {
  async mounted() {
    let {
      format: { WMTSCapabilities },
      Map,
      View,
      layer: { Tile: TileLayer },
      source: { WMTS },
      has: { DEVICE_PIXEL_RATIO },
    } = ol
    const hiDPI = DEVICE_PIXEL_RATIO > 1
    const layer = hiDPI ? "bmaphidpi" : "geolandbasemap"
    const tilePixelRatio = hiDPI ? 2 : 1

    const map = new Map({
      target: this.$refs.map,
      view: new View({
        center: [1823849, 6143760],
        zoom: 11,
      }),
    })
    let res = await axios.get("https://basemap.at/wmts/1.0.0/WMTSCapabilities.xml")
    const result = new WMTSCapabilities().read(res.data)
    const options = WMTS.optionsFromCapabilities(result, {
      layer: layer,
      matrixSet: "google3857",
      style: "normal",
    })
    options.tilePixelRatio = tilePixelRatio
    options.attributions =
      'Grundkarte: <a target="_blank" href="https://basemap.at/">basemap.at</a>'
    map.addLayer(
      new TileLayer({
        source: new WMTS(options),
      })
    )
  },
}
</script>
```

:::

## 2.IIIFInfo

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
  <div class="controls">
    <div id="iiif-notification">&nbsp;</div>
    <label for="imageInfoUrl">Enter <code>info.json</code> URL:</label>
    <input
      type="text"
      id="imageInfoUrl"
      value="https://iiif.ub.uni-leipzig.de/iiif/j2k/0000/0107/0000010732/00000072.jpx/info.json"
    />
    <button id="display">Display image</button>
  </div>
</template>

<script>
export default {
  mounted() {
    let {
      format: { IIIFInfo },
      Map,
      View,
      layer: { Tile: TileLayer },
      source: { IIIF },
    } = ol

    const layer = new TileLayer(),
      map = new Map({
        layers: [layer],
        target: this.$refs.map,
      }),
      notifyDiv = document.getElementById("iiif-notification"),
      urlInput = document.getElementById("imageInfoUrl"),
      displayButton = document.getElementById("display")

    function refreshMap(imageInfoUrl) {
      fetch(imageInfoUrl)
        .then(function (response) {
          response
            .json()
            .then(function (imageInfo) {
              const options = new IIIFInfo(imageInfo).getTileSourceOptions()
              if (options === undefined || options.version === undefined) {
                notifyDiv.textContent =
                  "Data seems to be no valid IIIF image information."
                return
              }
              options.zDirection = -1
              const iiifTileSource = new IIIF(options)
              layer.setSource(iiifTileSource)
              map.setView(
                new View({
                  resolutions: iiifTileSource.getTileGrid().getResolutions(),
                  extent: iiifTileSource.getTileGrid().getExtent(),
                  constrainOnlyCenter: true,
                })
              )
              map.getView().fit(iiifTileSource.getTileGrid().getExtent())
              notifyDiv.textContent = ""
            })
            .catch(function (body) {
              notifyDiv.textContent = "Could not read image info json. " + body
            })
        })
        .catch(function () {
          notifyDiv.textContent = "Could not read data from URL."
        })
    }

    displayButton.addEventListener("click", function () {
      refreshMap(urlInput.value)
    })

    refreshMap(urlInput.value)
  },
}
</script>
```

:::

## 3.WMSGetFeatureInfo

:::demo

```vue
<template>
  <table ref="info">
    <tr>
      <td>All features:</td>
      <td ref="all"></td>
    </tr>
    <tr>
      <td>Hotel features:</td>
      <td ref="hotel"></td>
    </tr>
    <tr>
      <td>Restaurant features:</td>
      <td ref="restaurant"></td>
    </tr>
  </table>
</template>

<script>
export default {
  async mounted() {
    let {
      format: { WMSGetFeatureInfo },
    } = ol
    let res = await axios.get(
      this.$withBase("/data/wmsgetfeatureinfo/osm-restaurant-hotel.xml")
    )
    const allFeatures = new WMSGetFeatureInfo().readFeatures(res.data)
    this.$refs.all.innerText = allFeatures.length.toString()
    const hotelFeatures = new WMSGetFeatureInfo({
      layers: ["hotel"],
    }).readFeatures(res.data)
    this.$refs.hotel.innerText = hotelFeatures.length.toString()
    const restaurantFeatures = new WMSGetFeatureInfo({
      layers: ["restaurant"],
    }).readFeatures(res.data)
    this.$refs.restaurant.innerText = restaurantFeatures.length.toString()
  },
}
</script>
```

:::

## 4.TopoJSON

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
</template>

<script>
export default {
  mounted() {
    let {
      format: { TopoJSON },
      Map,
      View,
      layer: { Tile: TileLayer, Vector: VectorLayer },
      source: { XYZ, Vector: VectorSource },
      style: { Fill, Stroke, Style },
    } = ol
    const attributions =
      '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> ' +
      '<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'
    const raster = new TileLayer({
      source: new XYZ({
        attributions: attributions,
        url:
          "https://api.maptiler.com/maps/darkmatter/{z}/{x}/{y}.png?key=" +
          mapkeys.maptiler,
        tileSize: 512,
      }),
    })
    const style = new Style({
      fill: new Fill({
        color: "rgba(255, 255, 255, 0.6)",
      }),
      stroke: new Stroke({
        color: "#319FD3",
        width: 1,
      }),
    })
    const vector = new VectorLayer({
      source: new VectorSource({
        url: this.$withBase("/data/topojson/world-110m.json"),
        format: new TopoJSON({
          layers: ["countries"],
        }),
        overlaps: false,
      }),
      style: style,
    })
    const map = new Map({
      layers: [raster, vector],
      target: this.$refs.map,
      view: new View({
        center: [12579156, 3274244],
        zoom: 1,
      }),
    })
  },
}
</script>
```

:::



## 5.GeoJSON

### 街道标签

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
</template>

<script>
export default {
  mounted() {
    let {
      format: { GeoJSON },
      Map,
      View,
      layer: { Tile: TileLayer, Vector: VectorLayer },
      source: { XYZ, Vector: VectorSource },
      style: { Fill, Style, Text },
      extent: { getCenter },
    } = ol

    const style = new Style({
      text: new Text({
        font: 'bold 11px "Open Sans", "Arial Unicode MS", "sans-serif"',
        placement: "line",
        fill: new Fill({
          color: "white",
        }),
      }),
    })

    const attributions =
      '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> ' +
      '<a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'

    const viewExtent = [1817379, 6139595, 1827851, 6143616]
    const map = new Map({
      layers: [
        new TileLayer({
          source: new XYZ({
            attributions: attributions,
            url:
              "https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=" +
              mapkeys.maptiler,
            maxZoom: 20,
          }),
        }),
        new VectorLayer({
          declutter: true,
          source: new VectorSource({
            format: new GeoJSON(),
            url: this.$withBase("/data/geojson/vienna-streets.geojson"),
          }),
          style: function (feature) {
            style.getText().setText(feature.get("name"))
            return style
          },
        }),
      ],
      target: this.$refs.map,
      view: new View({
        extent: viewExtent,
        center: getCenter(viewExtent),
        zoom: 17,
        minZoom: 14,
      }),
    })
  },
}
</script>
```

:::

### 样式渲染器

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
  <div id="info">&nbsp;</div>
</template>

<script>
export default {
  mounted() {
    let {
      format: { GeoJSON },
      Map,
      View,
      layer: { Vector: VectorLayer },
      source: { Vector: VectorSource },
      style: { Fill, Stroke, Style },
      extent: { getBottomLeft, getHeight, getWidth },
      render: { toContext },
    } = ol

    const fill = new Fill()
    const stroke = new Stroke({
      color: "rgba(255,255,255,0.8)",
      width: 2,
    })
    const style = new Style({
      renderer: function (pixelCoordinates, state) {
        const context = state.context
        const geometry = state.geometry.clone()
        geometry.setCoordinates(pixelCoordinates)
        const extent = geometry.getExtent()
        const width = getWidth(extent)
        const height = getHeight(extent)
        const flag = state.feature.get("flag")
        if (!flag || height < 1 || width < 1) {
          return
        }
        context.save()
        const renderContext = toContext(context, {
          pixelRatio: 1,
        })
        renderContext.setFillStrokeStyle(fill, stroke)
        renderContext.drawGeometry(geometry)
        context.clip()
        const bottomLeft = getBottomLeft(extent)
        const left = bottomLeft[0]
        const bottom = bottomLeft[1]
        context.drawImage(flag, left, bottom, width, height)
        context.restore()
      },
    })

    const vectorLayer = new VectorLayer({
      source: new VectorSource({
        url: "https://openlayersbook.github.io/openlayers_book_samples/assets/data/countries.geojson",
        format: new GeoJSON(),
      }),
      style: style,
    })
    vectorLayer.getSource().on("addfeature", function (event) {
      const feature = event.feature
      const img = new Image()
      img.onload = function () {
        feature.set("flag", img)
      }
      img.src =
        "https://flagcdn.com/w320/" +
        feature.get("iso_a2").toLowerCase() +
        ".png"
    })

    new Map({
      layers: [vectorLayer],
      target: this.$refs.map,
      view: new View({
        center: [12579156, 3274244],
        zoom: 1,
      }),
    })
  },
}
</script>
```

:::

## 6.KML

:::demo

```vue
<template>
  <div ref="map" class="map"></div>
</template>

<script>
export default {
  mounted() {
    let {
      format: { KML },
      Map,
      View,
      layer: { Vector: VectorLayer },
      source: { Vector: VectorSource },
      has: { DEVICE_PIXEL_RATIO },
      style: { Fill, Stroke, Style },
      proj: { fromLonLat },
    } = ol
    const pixelRatio = DEVICE_PIXEL_RATIO
    const canvas = document.createElement("canvas")
    const context = canvas.getContext("2d")
    const gradient = context.createLinearGradient(0, 0, 1024 * pixelRatio, 0)
    gradient.addColorStop(0, "red")
    gradient.addColorStop(1 / 6, "orange")
    gradient.addColorStop(2 / 6, "yellow")
    gradient.addColorStop(3 / 6, "green")
    gradient.addColorStop(4 / 6, "aqua")
    gradient.addColorStop(5 / 6, "blue")
    gradient.addColorStop(1, "purple")
    const vectorLayer = new VectorLayer({
      background: "white",
      source: new VectorSource({
        url: this.$withBase("/data/kml/states.kml"),
        format: new KML({ extractStyles: false }),
      }),
      style: new Style({
        fill: new Fill({ color: gradient }),
        stroke: new Stroke({
          color: "#333",
          width: 1,
        }),
      }),
    })
    const map = new Map({
      layers: [vectorLayer],
      target: this.$refs.map,
      view: new View({
        center: fromLonLat([-100, 38.5]),
        zoom: 4,
      }),
    })
  },
}
</script>
```

:::
## 7.feature 转数据

- 矢量图形的 feature --> WKT
- 矢量图形的 feature --> GeoJSON

```js
//WKT
var wktshape = new ol.format.WKT().writeFeature(feature)
//GeoJSON
var jsonshape = new ol.format.GeoJSON().writeFeature(feature)
//字符串
var stringPoint = feature.getGeometry().getCoordinates().toString()
```